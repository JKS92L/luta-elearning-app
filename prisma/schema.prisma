generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String           @id @default(cuid())
  email         String           @unique
  name          String?
  avatar        String?
  role          UserRole         @default(STUDENT)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  studentProfile StudentProfile?
  teacherProfile TeacherProfile?
  payments       Payment[]
  enrollments    ClassEnrollment[]
  chatSessions   ChatSession[]
  progress       StudentProgress[]
  watchHistory   WatchHistory[]

  @@map("users")
}

model StudentProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  gradeLevel  String?
  interests   String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("student_profiles")
}

model TeacherProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  bio       String?
  expertise String?
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  classes Class[]

  @@map("teacher_profiles")
}

model Subject {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  createdAt   DateTime @default(now())

  classes Class[]

  @@map("subjects")
}

model Class {
  id          String   @id @default(cuid())
  name        String
  description String?
  teacherId   String
  subjectId   String
  price       Float
  createdAt   DateTime @default(now())

  teacher     TeacherProfile @relation(fields: [teacherId], references: [id])
  subject     Subject        @relation(fields: [subjectId], references: [id])
  modules     Module[]
  enrollments ClassEnrollment[]

  @@map("classes")
}

model ClassEnrollment {
  id          String           @id @default(cuid())
  studentId   String
  classId     String
  enrolledAt  DateTime          @default(now())
  status      EnrollmentStatus  @default(ACTIVE)

  student     User              @relation(fields: [studentId], references: [id])
  class       Class             @relation(fields: [classId], references: [id])
  payment     Payment?

  @@unique([studentId, classId])
  @@map("class_enrollments")
}

model Module {
  id          String   @id @default(cuid())
  classId     String
  title       String
  description String?
  orderIndex  Int
  createdAt   DateTime @default(now())

  class   Class   @relation(fields: [classId], references: [id])
  lessons Lesson[]

  @@map("modules")
}

model Lesson {
  id              String   @id @default(cuid())
  moduleId        String
  title           String
  description     String?
  videoUrl        String
  duration        Int // in seconds
  orderIndex      Int
  createdAt       DateTime @default(now())

  module          Module           @relation(fields: [moduleId], references: [id])
  resources       LessonResource[]
  chatSessions    ChatSession[]
  studentProgress StudentProgress[]
  watchHistory    WatchHistory[]

  @@map("lessons")
}

model LessonResource {
  id        String   @id @default(cuid())
  lessonId  String
  title     String
  fileUrl   String
  type      ResourceType
  createdAt DateTime @default(now())

  lesson Lesson @relation(fields: [lessonId], references: [id])

  @@map("lesson_resources")
}

model Payment {
  id                     String        @id @default(cuid())
  studentId              String
  enrollmentId           String?       @unique   // âœ… must be unique for 1:1 relation
  amount                 Float
  currency               String        @default("USD")
  status                 PaymentStatus @default(PENDING)
  stripePaymentIntentId  String?
  createdAt              DateTime      @default(now())

  student    User             @relation(fields: [studentId], references: [id])
  enrollment ClassEnrollment? @relation(fields: [enrollmentId], references: [id])

  @@map("payments")
}

model ChatSession {
  id        String   @id @default(cuid())
  studentId String
  lessonId  String
  title     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student   User          @relation(fields: [studentId], references: [id])
  lesson    Lesson        @relation(fields: [lessonId], references: [id])
  messages  ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id        String   @id @default(cuid())
  sessionId String
  role      MessageRole
  content   String
  metadata  Json?
  createdAt DateTime @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model StudentProgress {
  id                 String   @id @default(cuid())
  studentId          String
  lessonId           String
  progressPercentage Float    @default(0)
  completedAt        DateTime?
  lastWatchedAt      DateTime @default(now())

  student User   @relation(fields: [studentId], references: [id])
  lesson  Lesson @relation(fields: [lessonId], references: [id])

  @@unique([studentId, lessonId])
  @@map("student_progress")
}

model WatchHistory {
  id               String   @id @default(cuid())
  studentId        String
  lessonId         String
  watchTimeSeconds Int
  createdAt        DateTime @default(now())

  student User   @relation(fields: [studentId], references: [id])
  lesson  Lesson @relation(fields: [lessonId], references: [id])

  @@map("watch_history")
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum EnrollmentStatus {
  ACTIVE
  INACTIVE
  COMPLETED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ResourceType {
  PDF
  VIDEO
  IMAGE
  LINK
  DOCUMENT
}

enum MessageRole {
  USER
  ASSISTANT
}
